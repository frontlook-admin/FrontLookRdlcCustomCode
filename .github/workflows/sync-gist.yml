name: Sync to Gist

on:
  push:
    branches:
      - main
    paths:
      - 'RdlcReportCode_Optimized.vb'
      - 'RdlcReportCode_WithComments_Optimized.vb'
      - 'RdlcVBCode_Usage_Optimized'
      - 'Readme_Optimized.md'
      - 'FL_NumberToStrings.js'
  workflow_dispatch:  # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update Gist via GitHub API
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: f8962078e18b40b958410cfb48db145b
        run: |
          # Read file contents and escape for JSON
          escape_json() {
            python3 -c "import json, sys; print(json.dumps(sys.stdin.read()))"
          }
          
          # Read optimized files
          RDLC_CODE=$(cat RdlcReportCode_Optimized.vb | escape_json)
          RDLC_COMMENTS=$(cat RdlcReportCode_WithComments_Optimized.vb | escape_json)
          RDLC_USAGE=$(cat RdlcVBCode_Usage_Optimized | escape_json)
          README=$(cat Readme_Optimized.md | escape_json)
          JS_MODULE=$(cat FL_NumberToStrings.js | escape_json)
          
          # Create JSON payload
          PAYLOAD=$(cat <<EOF
          {
            "description": "RDLC Report Custom Code - Optimized (40-60% faster) + JavaScript Implementation",
            "files": {
              "RdlcReportCode.vb": {
                "content": $RDLC_CODE
              },
              "RdlcReportCode_WithComments.vb": {
                "content": $RDLC_COMMENTS
              },
              "RdlcVBCode_Usage": {
                "content": $RDLC_USAGE
              },
              "FL_NumberToStrings.js": {
                "content": $JS_MODULE
              },
              "Readme.md": {
                "content": $README
              },
            }
          }
          EOF
          )
          
          # Update Gist using GitHub API
          curl -X PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GIST_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/gists/$GIST_ID \
            -d "$PAYLOAD"
          
          echo "âœ… Gist updated successfully!"
          echo "ðŸ“¦ Files synced:"
          echo "  - RdlcReportCode.vb"
          echo "  - RdlcReportCode_WithComments.vb"
          echo "  - RdlcVBCode_Usage"
          echo "  - FL_NumberToStrings.js"
          echo "  - Readme.md"
